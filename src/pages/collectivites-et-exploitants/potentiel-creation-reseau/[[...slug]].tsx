import Highlight from '@codegouvfr/react-dsfr/Highlight';
import { GetStaticPaths, InferGetStaticPropsType } from 'next';
import Image from 'next/image';
import { useRouter } from 'next/navigation';
import React from 'react';

import AddressAutocompleteInput from '@components/form/dsfr/AddressAutocompleteInput';
import VillesPotentielMapLegend from '@components/Map/components/VillesPotentielMapLegend';
import Map from '@components/Map/Map';
import SimplePage from '@components/shared/page/SimplePage';
import Button from '@components/ui//Button';
import Box from '@components/ui/Box';
import Heading from '@components/ui/Heading';
import Link from '@components/ui/Link';
import Text from '@components/ui/Text';
import Tooltip from '@components/ui/Tooltip';
import { getCommunePotentiel } from '@core/infrastructure/repository/zoneAPotentiel';
import { createMapConfiguration } from 'src/services/Map/map-configuration';

type PotentielCreationReseauPageProps = InferGetStaticPropsType<typeof getStaticProps>;

const franceBounds: [number, number, number, number] = [-9.3175, 41.2634, 13.6625, 52.124];

const DetailsCommune: React.FC<{ commune: NonNullable<PotentielCreationReseauPageProps['commune']> }> = ({ commune }) => {
  const router = useRouter();
  return (
    <>
      <Button
        onClick={() => router.push('/collectivites-et-exploitants/potentiel-creation-reseau')}
        priority="secondary"
        size="small"
        iconId="fr-icon-arrow-left-line"
        className="fr-mb-2w"
      >
        Retour
      </Button>
      <Box py="2w">
        <Heading as="h1" size="h3">
          {commune.nom}
        </Heading>
        <Text size="lg" fontWeight="bold">
          {commune.nbReseauxExistants > 0
            ? 'Votre ville est déjà équipée d’un réseau de chaleur !'
            : commune.nbZonesAFortPotentiel > 0
            ? 'Il existe un fort potentiel pour la création d’un réseau de chaleur sur votre territoire'
            : commune.nbZonesAPotentiel > 0
            ? 'Il existe un potentiel pour la création d’un réseau de chaleur sur votre territoire'
            : 'Une étude plus fine sur la base des consommations réelles des bâtiments est nécessaires'}
        </Text>
      </Box>
      {commune.nbReseauxExistants > 0 ? (
        <Box py="1w">
          <p className="fr-text--sm">
            Retrouvez tous les services proposés par France Chaleur Urbaine aux collectivités déjà équipées d’un réseau sur{' '}
            <Link href="/collectivites-et-exploitants">notre page dédiée</Link>.
          </p>
        </Box>
      ) : commune.nbZonesAPotentiel > 0 ? (
        <>
          <Box py="1w">
            {commune.nbZonesAFortPotentiel > 0 ? (
              <>
                <Text color="success" className="fr-text--lg" fontWeight="bold">
                  {commune.nbZonesAFortPotentiel}
                </Text>
                <p className="fr-text--sm">
                  <strong>zones d’opportunité à fort potentiel</strong> identifiées. Il s’agit de secteurs sur lesquels le développement
                  d’un réseau de chaleur apparaît pertinent.
                </p>
              </>
            ) : (
              <>
                <Text color="success" className="fr-text--lg" fontWeight="bold">
                  {commune.nbZonesAPotentiel}
                </Text>
                <p className="fr-text--sm">
                  <strong>zones d’opportunité à potentiel</strong> identifiées. Il s’agit de secteurs sur lesquels le développement d’un
                  réseau de chaleur apparaît possible.
                </p>
              </>
            )}
          </Box>
          <Box py="1w">
            <Text color="success" className="fr-text--lg" fontWeight="bold">
              {commune.besoinsChauffage.toLocaleString('fr-FR', { maximumFractionDigits: 1 })} GWh/an{' '}
              <Tooltip
                title="Ordre de grandeur : la consommation en chauffage pour un logement moyen de 70m² est de l’ordre de 10 MWh/an, soit 0,01 GWh/an"
                iconProps={{
                  color: 'var(--text-action-high-blue-france)',
                }}
              />
            </Text>
            <p className="fr-text--sm">
              <strong>besoin en chauffage</strong> cumulés sur ces zones
            </p>
          </Box>
          <Box py="1w">
            <Text color="success" className="fr-text--lg" fontWeight="bold">
              {commune.besoinsECS.toLocaleString('fr-FR', { maximumFractionDigits: 1 })} GWh/an
            </Text>
            <p className="fr-text--sm">
              <strong>besoin en eau chaude sanitaire</strong> cumulés sur ces zones
            </p>
          </Box>
        </>
      ) : (
        <Box py="1w">
          <p className="fr-text--sm">
            En effet nous n'avons pas identifié de potentiel pour la création de réseau de chaleur sur votre territoire, sur la base des
            modélisations des besoins en chaleur des bâtiments. Mais cela ne signifie pas que la création d'un réseau sur votre territoire
            est impossible !
          </p>
        </Box>
      )}
    </>
  );
};

const SearchCommune: React.FC = () => {
  const router = useRouter();
  return (
    <Box p="2w">
      <Heading as="h1" size="h3">
        Votre commune n’a pas de réseau de chaleur&nbsp;?
      </Heading>
      <AddressAutocompleteInput
        label="Testez en un clic le potentiel pour la création d'un réseau de chaleur sur votre territoire"
        onlyCities
        nativeInputProps={{ placeholder: 'Nom de votre commune' }}
        onSelect={(address) => {
          router.push(
            `/collectivites-et-exploitants/potentiel-creation-reseau/${address.properties.citycode}-${encodeURIComponent(
              address.properties.city
            )}`
          );
        }}
      />
    </Box>
  );
};

const PotentielCreationReseauPage: React.FC<PotentielCreationReseauPageProps> = ({ commune }) => {
  const bounds = commune?.bounds || franceBounds;
  return (
    <SimplePage title="Potentiel de création de réseau" mode="public-fullscreen">
      <div className="fr-container fr-mt-2w">
        <div className="fr-grid-row">
          <div className="fr-col-12 fr-col-md-4 fr-my-2w" style={{ minHeight: '50vh' }}>
            {commune ? <DetailsCommune commune={commune} /> : <SearchCommune />}
          </div>
          <div className="fr-col-12 fr-col-md-8" style={{ minHeight: '50vh' }}>
            <Map
              withoutLogo
              withPins={false}
              geolocDisabled
              withLegend
              legendCollapsed={true}
              components={{
                legend: <VillesPotentielMapLegend />,
              }}
              bounds={bounds}
              initialMapConfiguration={createMapConfiguration({
                reseauxDeChaleur: {
                  show: true,
                },
                zonesOpportunite: {
                  show: true,
                },
                besoinsEnChaleur: true,
                reseauxEnConstruction: true,
                zonesDeDeveloppementPrioritaire: true,
              })}
            />
          </div>
        </div>
      </div>
      <Box py="10w" backgroundColor="blue-france-975-75">
        <div className="fr-container">
          <Heading as="h2" size="h3">
            Pourquoi créer un réseau de chaleur sur mon territoire ?
          </Heading>
          <Box className="fr-grid-row fr-grid-row--gutters" mt="10w">
            <Box display="flex" flexDirection="column" className="fr-col-12 fr-col-lg-6 fr-col-xl-4">
              <Image src="/img/copro_avantages_1.webp" alt="" width={160} height={125} priority className="img-object-contain" />
              <Text mt="2w">Un coût de la chaleur plus stable que celui des énergies fossiles, et souvent plus compétitif.</Text>
            </Box>

            <Box display="flex" flexDirection="column" className="fr-col-12 fr-col-lg-6 fr-col-xl-4">
              <Image src="/img/copro_avantages_3.webp" alt="" width={160} height={125} priority className="img-object-contain" />
              <Text mt="2w">
                Un mode de chauffage faiblement carboné. En moyenne deux fois moins de gaz à effet de serre que le gaz et trois fois moins
                que le fioul !
              </Text>
            </Box>

            <Box display="flex" flexDirection="column" className="fr-col-12 fr-col-lg-6 fr-col-xl-4">
              <Image src="/img/collectivite_picto_2.webp" alt="" width={160} height={125} priority className="img-object-contain" />
              <Text mt="2w">Une source d’emplois locaux non délocalisables.</Text>
            </Box>
          </Box>
          <Highlight className="fr-mt-8w fr-pt-2w fr-pb-1v">
            <Text as="span" size="lg" fontWeight="bold" display="block">
              La chaleur représente près de 45 % de l'énergie consommée en France.
            </Text>
            <Text as="span" mb="0" display="block">
              Les réseaux de chaleur, qui exploitent des énergies renouvelables et de récupération telles que la chaleur des déchets, la
              biomasse et la géothermie, offrent de nombreux avantages.
            </Text>
          </Highlight>
        </div>
      </Box>
      <Box py="10w">
        <div className="fr-container">
          <div className="fr-grid-row">
            <div className="fr-col-12 fr-col-md-7">
              <Heading as="h4" color="blue-france" id="iframe-carte">
                Affinez votre projet avec notre carte !
              </Heading>
              <div>
                Vous y trouverez :
                <ul>
                  <li>
                    <strong>Les réseaux déjà existants</strong> dans les communes voisines
                  </li>
                  <li>
                    <strong>Des données à l’adresse sur les consommations réelles</strong> des bâtiments et leur mode de chauffage
                  </li>
                  <li>
                    <strong>Des données sur certaines énergies renouvelables et de récupération thermiques</strong> disponibles sur votre
                    territoire
                  </li>
                </ul>
              </div>
              <Button className="fr-mt-2w" priority="primary" href={`/carte?bounds=${encodeURIComponent(JSON.stringify(bounds))}`}>
                Accéder à la carte
              </Button>
            </div>
            <div className="fr-col-12 fr-col-md-5">
              <Image src="/img/screenshot_map.webp" alt="" width={448} height={353} priority className="img-object-contain" />
            </div>
          </div>
        </div>
      </Box>
    </SimplePage>
  );
};

export const getStaticProps = async ({ params }: { params: { slug?: string } }) => {
  const codeInsee = (params?.slug?.[0] as string)?.split('-')[0];

  const commune = codeInsee ? await getCommunePotentiel(codeInsee) : null;

  if (codeInsee && !commune) {
    return {
      redirect: {
        destination: `/collectivites-et-exploitants/potentiel-creation-reseau?notify=error:${encodeURIComponent(
          "Désolé, nous n'avons pas trouvé la commune en question, essayez la carte"
        )}`,
        permanent: false,
      },
    };
  }

  return {
    props: {
      commune,
    },
  };
};

export const getStaticPaths: GetStaticPaths = async () => {
  return {
    paths: [],
    fallback: 'blocking',
  };
};

export default PotentielCreationReseauPage;
