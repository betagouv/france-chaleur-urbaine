import { fr } from '@codegouvfr/react-dsfr';
import Highlight from '@codegouvfr/react-dsfr/Highlight';
import { type GetStaticPaths, type InferGetStaticPropsType } from 'next';
import { usePathname, useRouter } from 'next/navigation';
import React, { useEffect } from 'react';
import styled, { css } from 'styled-components';

import AddressAutocompleteInput from '@/components/form/dsfr/AddressAutocompleteInput';
import VillesPotentielMapLegend from '@/components/Map/components/VillesPotentielMapLegend';
import { FullyFeaturedMap } from '@/components/Map/Map';
import { createMapConfiguration } from '@/components/Map/map-configuration';
import useFCUMap, { FCUMapContextProvider } from '@/components/Map/MapProvider';
import MarkdownWrapper from '@/components/MarkdownWrapper';
import SimplePage from '@/components/shared/page/SimplePage';
import Box from '@/components/ui/Box';
import Button from '@/components/ui/Button';
import Heading from '@/components/ui/Heading';
import Image from '@/components/ui/Image';
import Link from '@/components/ui/Link';
import Modal, { createModal } from '@/components/ui/Modal';
import Newsletter, {
  NewsletterButton,
  NewsletterCheckbox,
  NewsletterError,
  NewsletterInput,
  NewsletterSection,
} from '@/components/ui/Newsletter';
import Text from '@/components/ui/Text';
import Tooltip from '@/components/ui/Tooltip';
import { trackEvent } from '@/modules/analytics/client';
import { notify } from '@/modules/notification';
import { getCommunePotentiel } from '@/server/services/communeAPotentiel';
import { submitToAirtable } from '@/services/airtable';
import { type BoundingBox } from '@/types/Coords';
import { Airtable } from '@/types/enum/Airtable';

export type PotentielCreationReseauPageProps = InferGetStaticPropsType<typeof getStaticProps>;

// construit avec `SELECT box2D(st_extent(ST_Transform(geom, 4326))) FROM public.ign_communes;`
export const franceBounds: BoundingBox = [-5.14127657354623, 41.33355568615941, 9.56009360694225, 51.08898944078367];

const modalExplanation = createModal({
  id: 'potentiel-creation-reseau-explication-modal',
  isOpenedByDefault: false,
});

export const DetailsCommune: React.FC<{ commune: NonNullable<PotentielCreationReseauPageProps['commune']> }> = ({ commune }) => {
  const router = useRouter();
  const pathname = usePathname();

  React.useEffect(() => {
    trackEvent(`Villes Potentiel - Visites|${commune.type}`, commune.nom);
  }, [commune]);

  return (
    <>
      <Button
        onClick={() => router.push(pathname.split('/').slice(0, -1).join('/'))} // supprime le dernier niveau (commune) pour retourner à la page de recherche
        priority="secondary"
        size="small"
        iconId="fr-icon-arrow-left-line"
        className="fr-mb-2w"
      >
        Retour
      </Button>
      <Box py="2w">
        <Heading as="h1" size="h3">
          {commune.nom}
        </Heading>
        <Text size="lg" fontWeight="bold">
          {commune.type === 'Réseau Existant'
            ? 'Votre ville est déjà équipée d’un réseau de chaleur !'
            : commune.type === 'Réseau Futur'
              ? 'Un réseau est déjà en construction sur votre ville !'
              : commune.type === 'Fort Potentiel'
                ? 'Il existe un fort potentiel pour la création d’un réseau de chaleur sur votre territoire'
                : commune.type === 'Potentiel'
                  ? 'Il existe un potentiel pour la création d’un réseau de chaleur sur votre territoire'
                  : 'Une étude plus fine sur la base des consommations réelles des bâtiments est nécessaire'}
        </Text>
      </Box>
      {commune.nbReseauxExistants > 0 ? (
        <Box py="1w">
          <p className="fr-text--sm">
            Retrouvez tous les services proposés par France Chaleur Urbaine aux collectivités déjà équipées d’un réseau sur{' '}
            <Link href="/collectivites-et-exploitants">notre page dédiée</Link>.
          </p>
        </Box>
      ) : commune.nbReseauxFuturs > 0 ? (
        <Box py="1w">
          <p className="fr-text--sm">
            Découvrez comment nous pouvons vous accompagner dans le développement de votre réseau sur{' '}
            <Link href="/collectivites-et-exploitants">notre page dédiée</Link>.
          </p>
        </Box>
      ) : commune.zonesAPotentiel.nb > 0 ? (
        <>
          <Box py="1w">
            {commune.zonesAFortPotentiel.nb > 0 ? (
              <>
                <Text color="success" className="fr-text--lg" fontWeight="bold">
                  {commune.zonesAFortPotentiel.nb}
                </Text>
                <p className="fr-text--sm fr-mb-0">
                  <strong>{commune.zonesAFortPotentiel.nb > 1 ? 'zones' : 'zone'} d’opportunité à fort potentiel</strong>{' '}
                  {commune.zonesAFortPotentiel.nb > 1 ? 'identifiées' : 'identifiée'}. Il s’agit de secteurs sur lesquels le développement
                  d’un réseau de chaleur apparaît pertinent.
                </p>
              </>
            ) : (
              <>
                <Text color="success" className="fr-text--lg" fontWeight="bold">
                  {commune.zonesAPotentiel.nb}
                </Text>
                <p className="fr-text--sm fr-mb-0">
                  <strong>{commune.zonesAPotentiel.nb > 1 ? 'zones' : 'zone'} d’opportunité à potentiel</strong>{' '}
                  {commune.zonesAPotentiel.nb > 1 ? 'identifiées' : 'identifiée'}. Il s’agit de secteurs sur lesquels le développement d’un
                  réseau de chaleur apparaît possible.
                </p>
              </>
            )}
            <Link href="#" onClick={() => modalExplanation.open()} className={fr.cx('fr-link', 'fr-text--sm', 'fr-mb-2w')}>
              Comment sont établies les zones d’opportunité&nbsp;?
            </Link>

            <Modal modal={modalExplanation} title="Comment sont établies les zones d’opportunité ?" size="large">
              <MarkdownWrapper color="black">
                {`**Les zones d’opportunité sont créées par le Cerema dans le cadre du projet EnRezo, à partir de bâtiments sélectionnés en fonction de leurs besoins en chaleur et de leur proximité respective.**

Les besoins en chaleur des bâtiments sont modélisés sur la base de leurs caractéristiques (surface de plancher, application de ratios de consommation en fonction de l’année de construction et du type de bâtiment, avec une correction climatique et altimétrique selon leur localisation). Attention, il s’agit d’estimations et non de consommations réelles !

Une zone d’opportunité **“à fort potentiel”** englobe des bâtiments pouvant être reliés tout en respectant 3 conditions :
- **Un besoin en chaleur théorique supérieur à 300 MWh/an** pour chaque bâtiment pris en compte ;
- **Une distance maximale d’appareillement entre deux bâtiments de moins de 250 m** ;
- **Une densité thermique linéaire à vol d’oiseau de plus de 3MWh/an.ml**. La « densité thermique » à vol d’oiseau est égale aux besoins des bâtiments à raccorder divisés par la distance minimale entre eux.

Des zones d’opportunité **« à potentiel »** sont également définies, pour lesquels les **besoins en chaleur minimum par bâtiments sont abaissés à 100 MWh/an** au lieu de 300.

###### Attention, le mode de chauffage des bâtiments n’est pour le moment pas pris en compte pour le calcul de ces zones

Seuls les bâtiments à chauffage collectif pourront facilement être raccordés.
`}
              </MarkdownWrapper>
            </Modal>
          </Box>
          <Box py="1w" mt="2w">
            <Text color="success" className="fr-text--lg" fontWeight="bold">
              {(commune.zonesAFortPotentiel.chauffage || commune.zonesAPotentiel.chauffage).toLocaleString('fr-FR', {
                maximumFractionDigits: 1,
              })}{' '}
              MWh/an{' '}
              <Tooltip
                title="Ordre de grandeur : la consommation en chauffage pour un logement moyen de 70m² est de l’ordre de 10 MWh/an"
                iconProps={{
                  color: 'var(--text-action-high-blue-france)',
                }}
              />
            </Text>
            <p className="fr-text--sm">
              <strong>besoins en chauffage</strong> cumulés sur ces zones
            </p>
          </Box>
          <Box py="1w">
            <Text color="success" className="fr-text--lg" fontWeight="bold">
              {(commune.zonesAFortPotentiel.ecs || commune.zonesAPotentiel.ecs).toLocaleString('fr-FR', { maximumFractionDigits: 1 })}{' '}
              MWh/an
            </Text>
            <p className="fr-text--sm">
              <strong>besoins en eau chaude sanitaire</strong> cumulés sur ces zones
            </p>
          </Box>
        </>
      ) : (
        <Box py="1w">
          <p className="fr-text--sm">
            En effet, nous n'avons pas identifié de potentiel pour la création de réseau de chaleur sur votre territoire, sur la base des
            modélisations des besoins en chaleur des bâtiments. Mais cela ne signifie pas que la création d'un réseau sur votre territoire
            est impossible !
          </p>
        </Box>
      )}
      <Box py="1w">
        {(commune.nbReseauxExistants > 0 || commune.nbReseauxFuturs > 0) && (
          <p className="fr-text--sm">
            <strong>Vous souhaitez plus d’informations ?</strong>
          </p>
        )}
        <p className="fr-text--sm">
          <strong>Renseignez votre adresse mail pour avoir plus d’informations&nbsp;: nous reviendrons rapidement vers vous.</strong>
        </p>
        <Box className="fr-mt-2w" display="flex" flexDirection="column" alignItems="flex-start" justifyContent="stretch" gap="8px">
          <NewsletterInput />
          <NewsletterError className="fr-mt-0" />
          <NewsletterCheckbox label="J'atteste être élu ou agent de la collectivité." className="fr-mt-1w" />
          <NewsletterButton full>Envoyer</NewsletterButton>
        </Box>
      </Box>
    </>
  );
};

export const SearchCommune: React.FC = ({ className }: { className?: string }) => {
  const router = useRouter();
  const pathname = usePathname();
  return (
    <Box className={className}>
      <Heading as="h1" size="h3">
        Votre commune n’a pas de réseau de chaleur&nbsp;?
      </Heading>
      <AddressAutocompleteInput
        label="Testez en un clic le potentiel pour la création d'un réseau de chaleur sur votre territoire"
        onlyCities
        nativeInputProps={{ placeholder: 'Nom de votre commune' }}
        onSelect={(address) => {
          router.push(`${pathname}/${address.properties.citycode}-${encodeURIComponent(address.properties.city)}`);
        }}
      />
    </Box>
  );
};

const MapBoxWrapper = styled(Box)<{ $preventTouch?: boolean }>`
  ${({ $preventTouch }) =>
    $preventTouch &&
    css`
      pointer-events: none;
    `}
  ${({ theme }) =>
    theme.media.lg`
    height: 100%;
  `}
`;

export const Map = ({ commune, bounds }: { commune?: PotentielCreationReseauPageProps['commune']; bounds: BoundingBox }) => {
  const { updateProperty } = useFCUMap();

  useEffect(() => {
    updateProperty('reseauxDeChaleur.show', !!commune);
    updateProperty('zonesOpportunite.show', !!commune);
    updateProperty('besoinsEnChaleur', !!commune);
    updateProperty('reseauxEnConstruction', !!commune);
    updateProperty('communesFortPotentielPourCreationReseauxChaleur.show', !commune);
  }, [!!commune]);

  return (
    <MapBoxWrapper $preventTouch={!commune}>
      {commune && <VillesPotentielMapLegend />}
      <FullyFeaturedMap style={{ minHeight: 'max(500px, 50dvh)' }} withSoughtAddresses={false} geolocDisabled bounds={bounds} />
    </MapBoxWrapper>
  );
};

const WhatisRdcImageWrapper = styled.div`
  text-align: center;
  ${({ theme }) => theme.media.lg`
    text-align:right;
  `}
`;

export const submitDemandeCommuneSansReseau = async (commune: PotentielCreationReseauPageProps['commune'], email: string) => {
  if (!commune) {
    alert('Aucune commune n’a été sélectionnée');
    return;
  }
  trackEvent(`Villes Potentiel - Demandes|${commune.type}`, commune.nom);
  await submitToAirtable(
    {
      Email: email,
      Ville: commune.nom,
      Departement: commune.insee_dep,
      CodeInsee: commune.insee_com,
      Type: commune.type,
      NbZonesFortPotentiel: commune.zonesAFortPotentiel.nb,
      BesoinsEnChauffageZonesFortPotentiel: commune.zonesAFortPotentiel.chauffage,
      BesoinsEnECSZonesFortPotentiel: commune.zonesAFortPotentiel.ecs,
      NbZonesPotentiel: commune.zonesAPotentiel.nb,
      BesoinsEnChauffageZonesPotentiel: commune.zonesAPotentiel.chauffage,
      BesoinsEnECSZonesPotentiel: commune.zonesAPotentiel.ecs,
    },
    Airtable.COMMUNES_SANS_RESEAU
  );
  notify('success', `Merci pour votre demande, nous vous recontacterons très rapidement`);
};

const PotentielCreationReseauPage: React.FC<PotentielCreationReseauPageProps> = ({ commune }) => {
  const bounds = commune?.bounds || franceBounds;

  return (
    <SimplePage
      title={`Potentiel de création de réseau de chaleur ${commune ? `pour ${commune.nom}` : 'votre commune'}`}
      description={`Découvrez les zones qui pourraient être alimentées par un réseau de chaleur sur ${
        commune ? commune.nom : 'votre territoire'
      }, identifiez les bâtiments raccordables.`}
      mode="public-fullscreen"
      currentPage="/collectivites-et-exploitants/potentiel-creation-reseau"
    >
      <Newsletter onSignUp={(email) => submitDemandeCommuneSansReseau(commune, email)} withCheckbox>
        <div className="fr-container fr-mt-2w">
          <div className="fr-grid-row">
            <div className="fr-col-12 fr-col-lg-4 my-2 lg:pr-4">{commune ? <DetailsCommune commune={commune} /> : <SearchCommune />}</div>
            <div className="fr-col-12 fr-col-lg-8">
              <FCUMapContextProvider
                initialMapConfiguration={createMapConfiguration({
                  reseauxDeChaleur: {
                    show: !!commune,
                  },
                  zonesOpportunite: {
                    show: !!commune,
                  },
                  besoinsEnChaleur: !!commune,
                  reseauxEnConstruction: !!commune,
                  communesFortPotentielPourCreationReseauxChaleur: {
                    show: !commune,
                  },
                })}
              >
                <Map commune={commune} bounds={bounds} />
              </FCUMapContextProvider>
            </div>
          </div>
        </div>
        <Box py="8w" mt="2w" backgroundColor="blue-france-975-75">
          <div className="fr-container">
            <div className="fr-grid-row">
              <Box className="fr-col-12 fr-col-md-5" display="flex" flexDirection="column" justifyContent="center">
                <Heading as="h2" size="h3">
                  Qu’est-ce qu’un réseau de chaleur&nbsp;?
                </Heading>
                <p>
                  Un réseau de chaleur est un <strong>système de chauffage centralisé</strong> à l'échelle d’une ville ou d’un quartier, qui
                  permet de mobiliser des <strong>énergies renouvelables et de récupération locales</strong>.
                </p>
                <p>
                  La chaleur est ainsi produite au niveau d’une unité de production centrale puis acheminée vers un ensemble de bâtiments
                  via des canalisations souterraines.
                </p>
              </Box>
              <WhatisRdcImageWrapper className="fr-col-12 fr-col-md-7">
                <Image
                  src="/img/copro_comprendre.webp"
                  alt=""
                  width={477}
                  height={445}
                  priority
                  className="img-object-contain"
                  style={{ maxWidth: '100%' }}
                />
              </WhatisRdcImageWrapper>
            </div>
          </div>
        </Box>
        <Box py="8w">
          <div className="fr-container">
            <Heading as="h2" size="h3">
              Pourquoi créer un réseau de chaleur sur mon territoire ?
            </Heading>
            <Box className="fr-grid-row fr-grid-row--gutters" mt="8w">
              <Box display="flex" flexDirection="column" className="fr-col-12 fr-col-md-6 fr-col-lg-4" px="6w">
                <Image src="/img/copro_avantages_1.webp" alt="" width={160} height={125} priority className="img-object-contain" />
                <Text mt="2w">Un coût de la chaleur plus stable que celui des énergies fossiles, et souvent plus compétitif.</Text>
              </Box>

              <Box display="flex" flexDirection="column" className="fr-col-12 fr-col-md-6 fr-col-lg-4" px="6w">
                <Image src="/img/copro_avantages_3.webp" alt="" width={160} height={125} priority className="img-object-contain" />
                <Text mt="2w">
                  Un mode de chauffage faiblement carboné. En moyenne deux fois moins de gaz à effet de serre que le gaz et trois fois moins
                  que le fioul !
                </Text>
              </Box>

              <Box display="flex" flexDirection="column" className="fr-col-12 fr-col-md-6 fr-col-lg-4" px="6w">
                <Image src="/img/collectivite_picto_2.webp" alt="" width={160} height={125} priority className="img-object-contain" />
                <Text mt="2w">Une source d’emplois locaux non délocalisables.</Text>
              </Box>
            </Box>
            <Highlight className="fr-pt-2w fr-pb-1v fr-mt-8w">
              <Text as="span" size="lg" fontWeight="bold" display="block">
                La chaleur représente près de 45 % de l'énergie consommée en France.
              </Text>
              <Text as="span" mb="0" display="block">
                Les réseaux de chaleur, qui exploitent des énergies renouvelables et de récupération telles que la chaleur des déchets, la
                biomasse et la géothermie, offrent de nombreux avantages.
              </Text>
            </Highlight>
          </div>
        </Box>
        <Box py="8w" backgroundColor="blue-france-975-75">
          <div className="fr-container">
            <div className="fr-grid-row">
              <div className="fr-col-12 fr-col-md-7">
                <Heading as="h2" size="h3">
                  Affinez votre projet avec notre carte !
                </Heading>
                <div>
                  Vous y trouverez :
                  <ul>
                    <li>
                      <strong>Les réseaux déjà existants</strong> dans les communes voisines
                    </li>
                    <li>
                      <strong>Des données à l’adresse sur les consommations réelles</strong> des bâtiments et{' '}
                      <strong>leur mode de chauffage</strong>
                    </li>
                    <li>
                      <strong>Des données sur certaines énergies renouvelables et de récupération thermiques</strong> disponibles sur votre
                      territoire
                    </li>
                  </ul>
                </div>
                <Button className="fr-mt-2w" priority="primary" href={`/carte?bounds=${encodeURIComponent(JSON.stringify(bounds))}`}>
                  Accéder à la carte
                </Button>
              </div>
              <div className="fr-col-12 fr-col-md-5">
                <Image
                  src="/img/screenshot_map.webp"
                  alt=""
                  width={448}
                  height={353}
                  priority
                  className="img-object-contain"
                  style={{ maxWidth: '100%' }}
                />
              </div>
            </div>
          </div>
        </Box>

        <NewsletterSection
          backgroundColor="white"
          title="Vous avez besoin de plus d’informations…"
          subtitle="sur les aides financières disponibles, l’accompagnement mobilisable, les montages juridiques… ?"
          checkboxLabel="J'atteste être élu ou agent de la collectivité."
          buttonText="Envoyer"
        />
      </Newsletter>
    </SimplePage>
  );
};

export const getStaticProps = async ({ params }: { params: { slug?: string } }) => {
  const codeInsee = (params?.slug?.[0] as string)?.split('-')[0];

  const commune = codeInsee ? await getCommunePotentiel(codeInsee) : null;

  if (codeInsee && !commune) {
    return {
      redirect: {
        destination: `/collectivites-et-exploitants/potentiel-creation-reseau?notify=error:${encodeURIComponent(
          "Désolé, nous n'avons pas trouvé la commune en question. Réessayez avec une autre"
        )}`,
        permanent: false,
      },
    };
  }

  return {
    props: {
      commune,
    },
  };
};

export const getStaticPaths: GetStaticPaths = async () => {
  return {
    paths: [],
    fallback: 'blocking',
  };
};

export default PotentielCreationReseauPage;
